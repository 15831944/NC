<< NCAlgebra`
<< NCSDP`

Module[
  {
    a,x,F,vars,obj,
    n,data,
    abc,rules,
    exp,answer,
    Id,
    q,
    b,b1,c1,c2,d12,y,w,
    Ze,Zemn,Zexz,
    Idm,Zemm,Zenm,
    IdX,IdW,Zenpm
    (* These must be global for COMPleib
    A,B1,B,C1,CC,D11,D12,D21,
    nx,nu,nw,nz,ny
    *)
  },

  (* Test #1: Lyapunov inequality *)

  SNC[a, x];
  F = {a ** x + x ** tp[a] + 1, -x};
  vars = {x};
  obj = {-1};

  n = 2;
  A = {{0, 1}, {-1, -2}};

  data = {a -> A};

  {abc, rules} = NCSDP[F, vars, obj, data, DebugLevel -> 0];

  Id = IdentityMatrix[n];
  Ze = ConstantArray[0, {n,n}];
  answer = {
    {
      {A, 2 Id}
    },
    {
      {Id, -Id}
    }
  };
  NCTest[abc[[1]], answer];

  answer = {-Id};
  NCTest[abc[[2]], answer];

  answer = {-Id, Ze};
  NCTest[abc[[3]], answer];

  answer = SymmetricVariables->{1};
  NCTest[rules, answer];

  NCSDPDual[F, vars, obj];

];

If[0,

  (* Test #2: Lyapunov inequality *)

  SNC[a, q, x];
  F = {a ** x + x ** tp[a] + q, -x};
  vars = {x};
  obj = {-1};

  Q = {{2, 1}, {1, 2}};
  data = {a -> A, q -> Q};

  {abc, rules} = NCSDP[F, vars, obj, data, UserRules -> {tp[q] -> q}, DebugLevel -> 0];

  answer = {
    {
      {A, 2 Id}
    },
    {
      {Id, -Id}
    }
  };
  NCTest[abc[[1]], answer];

  answer = {-Id};
  NCTest[abc[[2]], answer];

  answer = {-Q, Ze};
  NCTest[abc[[3]], answer];

  answer = SymmetricVariables->{1};
  NCTest[rules, answer];


  (* Test #3: Modified Lyapunov inequality *)

  SNC[a, b, q, x];
  F = {a ** x + x ** tp[a] + b ** x ** tp[b] + q, -x};
  vars = {x};
  obj = {-1};

  Q = {{2, 1}, {1, 2}};
  B = A . A;
  data = {a -> A, b -> B, q -> Q};

  {abc, rules} = NCSDP[F, vars, obj, data, UserRules -> {tp[q] -> q}, DebugLevel -> 0];

  answer = {
    {
      {ArrayFlatten[{{A, B}}], ArrayFlatten[{{2 Id, Transpose[B]}}]}
    },
    {
      {Id, -Id}
    }
  };
  NCTest[abc[[1]], answer];

  answer = {-Id};
  NCTest[abc[[2]], answer];

  answer = {-Q, Ze};
  NCTest[abc[[3]], answer];

  answer = SymmetricVariables->{1};
  NCTest[rules, answer];


  (* Test #4: Stabilizability *)

  SNC[a, b, b1, c1, d12, x, y, w];
  F = {a ** x + b ** y + x ** tp[a] + tp[b ** y], -x + 1};
  vars = {x, y};
  obj = {-1, 0};

  << "COMPleib/MmaCOMPleib/AC3.m";
  data = {a -> A, b -> B, b1 -> B1, c1 -> C1, d12 -> D12};
  Id = IdentityMatrix[nx];
  Ze = ConstantArray[0, {nx,nx}];
  Zemn = ConstantArray[0, {nu,nx}];

  {abc, rules} = NCSDP[F, vars, obj, data, DebugLevel -> 0];

  answer = {
    {
      {A, 2 Id}, {B, 2 Id}
    },
    {
      {Id, -Id}, {Transpose[Zemn], Ze}
    }
  };
  NCTest[abc[[1]], answer];

  answer = {-Id, Zemn};
  NCTest[abc[[2]], answer];

  answer = {Ze, -Id};
  NCTest[abc[[3]], answer];

  answer = SymmetricVariables->{1};
  NCTest[rules, answer];


  (* Test #5: H2 control *)

  SNC[a, b, b1, c1, d12, x, y, w];
  F = {a ** x + b ** y + x ** tp[a] + tp[b ** y] + 
       b1 ** tp[b1], -{{w, c1 ** x + d12 ** y}, {tp[c1 ** x + d12 ** y], 
        x}}} /. tp[x] -> x /. c1 -> 0 /. d12 -> 1;
  vars = {x, y, w};
  obj = {0, 0, -1};

  << "COMPleib/MmaCOMPleib/AC3.m";
  data = {a -> A, b -> B, b1 -> B1};
  Idm=IdentityMatrix[nu];
  Zemm=ConstantArray[0,{nu,nu}];
  Zenm=ConstantArray[0,{nx,nu}];
  IdX=ArrayFlatten[{{Transpose[Zenm]},{Id}}];
  IdW=ArrayFlatten[{{Idm},{Zenm}}];
  Zenpm=ConstantArray[0,{nx+nu,nx+nu}];

  {abc, rules} = NCSDP[F, vars, obj, data, DebugLevel -> 0];

  answer = {
    {{A,2 Id},{B,2 Id},{Zenm,Transpose[Zenm]}},(* A X + B L < -I *)
    {{IdX,-Transpose[IdX]},{IdW,-2 Transpose[IdX]},{IdW,-Transpose[IdW]}} (* -[W, L; L^T X] < 0 *)
  };
  NCTest[abc[[1]], answer];

  answer = {Ze, Zemn,-Idm};
  NCTest[abc[[2]], answer];

  answer = {-B1.Transpose[B1], Zenpm};
  NCTest[abc[[3]], answer];

  answer = SymmetricVariables->{1,3};
  NCTest[rules, answer];


  (* Test #6: Hoo control *)

  SNC[a, b, b1, c1, d12, x, y];
  F = {{{a ** x + b ** y + x ** tp[a] + tp[b ** y] + b1 ** tp[b1], 
       x ** tp[c1] + tp[y] ** tp[d12]}, {c1 ** x + d12 ** y, -1}}, -x};
  vars = {x, y};
  obj = {};

  << "COMPleib/MmaCOMPleib/AC3.m";
  data = {a -> A, b -> B, b1 -> B1, c1 -> C1, d12 -> D12};

  {abc, rules} = NCSDP[F, vars, obj, data, DebugLevel -> 0];

  answer = {
    {{A,2 Id},{B,2 Id},{Zenm,Transpose[Zenm]}},(* A X + B L < -I *)
    {{IdX,-Transpose[IdX]},{IdW,-2 Transpose[IdX]},{IdW,-Transpose[IdW]}} (* -[W, L; L^T X] < 0 *)
  };
  NCTest[abc[[1]], answer];

  answer = {Ze, Zemn,-Idm};
  NCTest[abc[[2]], answer];

  answer = {-B1.Transpose[B1], Zenpm};
  NCTest[abc[[3]], answer];

  answer = SymmetricVariables->{1};
  NCTest[rules, answer];


  (* Test #7: Mixed H2/Hoo control *)

  SNC[a, b, b1, c1, d12, x, y, w];
  F = {{{a ** x + b ** y + x ** tp[a] + tp[b ** y] + b1 ** tp[b1], 
         x ** tp[c1] + tp[y] ** tp[d12]}, {c1 ** x + d12 ** y, -1}}, 
	 -{{w, y}, {tp[y], x}}};
  vars = {x, y, w};
  obj = {0, 0, -1};

  << "COMPleib/MmaCOMPleib/AC3.m";
  data = {a -> A, b -> B, b1 -> B1, c1 -> C1, d12 -> D12};

  {abc, rules} = NCSDP[F, vars, obj, data, DebugLevel -> 0];

];

If[0,

  (* Test #5: H2 control *)

  SNC[a, b, b1, c1, d12, x, y, w];
  F = {a ** x + b ** y + x ** tp[a] + tp[b ** y] + 
       b1 ** tp[b1], -{{w, c1 ** x + d12 ** y}, {tp[c1 ** x + d12 ** y], 
        x}}} /. tp[x] -> x;
  vars = {x, y, w};
  obj = {0, 0, -1};

  << "COMPleib/MmaCOMPleib/AC3.m";
  data = {a -> A, b -> B, b1 -> B1, c1 -> C1, d12 -> D12};
  Idm=IdentityMatrix[nu];
  Zemm=ConstantArray[0,{nu,nu}];
  Zenm=ConstantArray[0,{nx,nu}];
  IdX=ArrayFlatten[{{Transpose[Zenm]},{Id}}];
  IdW=ArrayFlatten[{{Idm},{Zenm}}];
  Zenpm=ConstantArray[0,{nx+nu,nx+nu}];

  {abc, rules} = NCSDP[F, vars, obj, data, DebugLevel -> 0];

  answer = {
    {{A,2 Id},{B,2 Id},{Zenm,Transpose[Zenm]}},(* A X + B L < -I *)
    {{IdX,-Transpose[IdX]},{IdW,-2 Transpose[IdX]},{IdW,-Transpose[IdW]}} (* -[W, L; L^T X] < 0 *)
  };
  NCTest[abc[[1]], answer];

  answer = {Ze, Zemn,-Idm};
  NCTest[abc[[2]], answer];

  answer = {-B1.Transpose[B1], Zenpm};
  NCTest[abc[[3]], answer];

  answer = SymmetricVariables->{1,3};
  NCTest[rules, answer];

];
